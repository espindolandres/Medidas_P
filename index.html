<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Calculadora profesional de niveles de tanques con interpolaci√≥n/extrapolaci√≥n controlada, tabla y hist√≥rico." />
  <title>Medidas de Tanques</title>

  <style>
    :root{
      --primary:#1976D2;
      --primary-hover:#1565c0;
      --bg1:#f4f7fb;
      --bg2:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#d7dde6;

      --success:#1b7f3a;
      --warning:#a84b2f;
      --error:#c62828;

      --shadow: 0 12px 35px rgba(2, 6, 23, 0.10);
      --radius: 14px;

      --s4:4px; --s8:8px; --s12:12px; --s16:16px; --s20:20px; --s24:24px; --s32:32px;

      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, #eef6fb 0%, transparent 60%),
        radial-gradient(1000px 600px at 90% 0%, #f2f4ff 0%, transparent 55%),
        linear-gradient(135deg, #f7fbff 0%, #e8f0fb 100%);
      padding: var(--s24);
    }

    .container{max-width: 980px; margin: 0 auto;}
    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: var(--s16);
      margin-bottom: var(--s20);
    }

    h1{
      margin:0;
      font-size: clamp(1.4rem, 2.2vw, 2.0rem);
      letter-spacing:-0.02em;
      line-height:1.15;
      color: var(--primary);
    }
    .subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 0.98rem;
      line-height: 1.4;
    }
    .pill{
      display:inline-flex; align-items:center; gap: var(--s8);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.75);
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
    }

    main{display:grid; gap: var(--s20);}

    .card{
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--s24);
    }

    .card-head{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: var(--s16);
      margin-bottom: var(--s16);
    }

    .card h2{
      margin:0;
      font-size:1.15rem;
      letter-spacing:-0.01em;
    }
    .muted{margin: 6px 0 0; color: var(--muted); font-size: 0.95rem; line-height:1.4}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--s16);
      margin-top: var(--s16);
    }
    .col-12{grid-column: span 12;}
    .col-6{grid-column: span 6;}
    .col-4{grid-column: span 4;}

    .field{display:flex; flex-direction:column; gap: var(--s8);}
    label{font-weight: 800; font-size: 0.93rem;}
    .help{margin:0; color: var(--muted); font-size: 0.88rem; line-height: 1.35;}

    input, select, button{font-family: var(--font); font-size: 0.95rem;}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fbfcfe;
      transition: border-color .15s, box-shadow .15s, background-color .15s;
    }
    input:focus, select:focus, button:focus{
      outline:none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(25,118,210,0.16);
    }

    select{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, #0f172a 50%),
        linear-gradient(135deg, #0f172a 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(1em + 2px),
        calc(100% - 13px) calc(1em + 2px);
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
      padding-right: 36px;
    }

    .invalid{
      border-color: rgba(198, 40, 40, 0.55) !important;
      box-shadow: 0 0 0 4px rgba(198, 40, 40, 0.12) !important;
      background: #fff7f7;
    }

    .row{
      display:flex; gap: var(--s12); align-items:center; flex-wrap:wrap;
    }

    .toggle{
      display:flex; align-items:center; gap: var(--s8);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f6f8fc;
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .toggle input{width:auto; margin:0;}

    .btns{display:flex; flex-wrap:wrap; gap: var(--s12); align-items:center;}
    button{
      border:none;
      border-radius: 10px;
      padding: 11px 14px;
      cursor:pointer;
      font-weight: 900;
      transition: transform .08s, background-color .15s, opacity .15s;
      user-select:none;
    }
    button:active{transform: translateY(1px);}
    button:disabled{opacity:0.55; cursor:not-allowed; transform:none;}

    .btn-primary{background: var(--primary); color:#fff;}
    .btn-primary:hover{background: var(--primary-hover);}
    .btn-secondary{background:#f3f6fb; color: var(--text); border: 1px solid var(--border);}
    .btn-secondary:hover{background:#edf2f8;}
    .btn-ghost{background: transparent; color: var(--text); border: 1px solid var(--border);}
    .btn-ghost:hover{background:#f6f8fc;}

    .alerts{margin-top: var(--s16); display:grid; gap: var(--s12);}
    .alert{
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      background: #fafcff;
      font-size: 0.92rem;
      line-height: 1.35;
    }
    .alert strong{font-weight: 900;}
    .alert.error{
      border-color: rgba(198, 40, 40, 0.35);
      background: rgba(198, 40, 40, 0.07);
    }
    .alert.warning{
      border-color: rgba(168, 75, 47, 0.35);
      background: rgba(168, 75, 47, 0.08);
    }
    .alert.info{
      border-color: rgba(25,118,210, 0.30);
      background: rgba(25,118,210, 0.07);
    }

    .result{
      margin-top: var(--s16);
      padding-top: var(--s16);
      border-top: 1px solid var(--border);
      display:none;
    }
    .result.active{display:block;}

    .metrics{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--s12);
      margin-top: var(--s12);
    }
    .metric{
      grid-column: span 3;
      border: 1px solid #d8eef7;
      background: linear-gradient(135deg, #f4fbfe 0%, #f7fbff 100%);
      border-radius: 12px;
      padding: var(--s16);
      min-height: 74px;
    }
    .metric .k{color: var(--muted); font-size: 0.85rem; margin-bottom: var(--s4);}
    .metric .v{font-weight: 900; font-size: 1.05rem; letter-spacing: -0.01em;}
    .metric .sub{margin-top: var(--s4); font-size: 0.85rem; color: var(--muted); font-family: var(--mono);}

    .table-wrap{
      overflow:auto;
      margin-top: var(--s12);
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      max-height: 360px;
    }
    table{width:100%; border-collapse:collapse; min-width: 760px;}
    thead th{
      text-align:center;
      font-size: 0.85rem;
      color: #fff;
      background: var(--primary);
      border-bottom: 1px solid var(--border);
      padding: 12px 10px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td{
      border-bottom: 1px solid #eef2f7;
      padding: 10px 10px;
      text-align:center;
      font-size: 0.92rem;
    }
    tbody tr:nth-child(even){background:#fafafa;}
    tbody tr.highlight{
      background: rgba(255, 193, 7, 0.18) !important;
      outline: 2px solid rgba(255, 193, 7, 0.35);
      outline-offset: -2px;
    }

    .toast{
      margin-top: var(--s12);
      min-height: 22px;
      color: var(--muted);
      font-size: 0.92rem;
    }

    footer{
      margin-top: var(--s24);
      text-align:center;
      color: var(--muted);
      font-size: 0.9rem;
      padding: var(--s16) 0;
      border-top: 1px solid var(--border);
    }
    footer strong{color: var(--text);}

    @media (max-width: 920px){
      header{flex-direction:column; align-items:flex-start;}
      .col-6,.col-4{grid-column: span 12;}
      .metric{grid-column: span 6;}
      table{min-width: 680px;}
    }
    @media (max-width: 520px){
      .metric{grid-column: span 12;}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;}
      button:active{transform:none;}
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#0b1220;
        --bg2:#0f172a;
        --text:#e5e7eb;
        --muted:#9aa4b2;
        --border:#263247;
        --shadow: 0 12px 35px rgba(0,0,0,0.55);
      }
      body{
        background:
          radial-gradient(1200px 700px at 10% 10%, rgba(25,118,210,0.18) 0%, transparent 55%),
          radial-gradient(1000px 600px at 90% 0%, rgba(99,102,241,0.18) 0%, transparent 55%),
          linear-gradient(135deg, #0b1220 0%, #0b1020 100%);
      }
      input,select{background:#0b1326; color: var(--text);}
      .btn-secondary{background:#0b1326;}
      .btn-secondary:hover{background:#0e1933;}
      .btn-ghost:hover{background:#0e1933;}
      .toggle{background:#0b1326;}
      .table-wrap{background:#0f172a;}
      tbody tr:nth-child(even){background: rgba(255,255,255,0.03);}
      .metric{background: linear-gradient(135deg, rgba(25,118,210,0.12) 0%, rgba(25,118,210,0.06) 100%); border-color: rgba(25,118,210,0.18);}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>Medidas de Tanques</h1>
        <p class="subtitle">
          Calcula por <strong>interpolaci√≥n lineal</strong> usando tu tabla de calibraci√≥n.
          Si activas extrapolaci√≥n, se permite un margen de <strong>¬±2 cm</strong> (resultado estimado).
        </p>
      </div>
      <div class="pill">‚úÖ Tabla ‚Ä¢ Resaltado ‚Ä¢ Historial ‚Ä¢ Extrap ¬±2 cm</div>
    </header>

    <main>
      <!-- ===================== ENTRADA ===================== -->
      <section class="card" aria-labelledby="hEntrada">
        <div class="card-head">
          <div>
            <h2 id="hEntrada">1) Selecci√≥n y c√°lculo</h2>
            <p class="muted">Elige el tanque y el modo. Ingresa un valor y calcula.</p>
          </div>
          <div class="btns">
            <button class="btn-ghost" id="btnResetState" type="button">Restablecer</button>
          </div>
        </div>

        <div class="grid">
          <div class="field col-6">
            <label for="tanque">Tanque</label>
            <select id="tanque"></select>
            <p class="help" id="tankMeta">‚Äî</p>
          </div>

          <div class="field col-6">
            <label for="modo">Modo de c√°lculo</label>
            <select id="modo">
              <option value="altura">Altura (cm) ‚Üí Litros</option>
              <option value="litros">Litros ‚Üí Altura (cm)</option>
              <option value="vacio">Vac√≠o (cm) ‚Üí Litros</option>
            </select>
            <p class="help" id="modoHelp">‚Äî</p>
          </div>

          <div class="field col-12">
            <label id="valorLabel" for="valor">Valor</label>
            <input id="valor" type="text" inputmode="decimal" placeholder="Ej: 39" />
            <p class="help" id="rango">‚Äî</p>

            <div class="row" style="margin-top: var(--s12);">
              <label class="toggle" title="Si est√° activo, se recalcula mientras escribes (sin guardar historial).">
                <input type="checkbox" id="autoCalc" />
                Vista previa autom√°tica
              </label>

              <label class="toggle" title="Permite extrapolar el c√°lculo hasta ¬±2 cm fuera del rango calibrado. El resultado ser√° estimado.">
                <input type="checkbox" id="allowExtrap" />
                Extrapolaci√≥n ¬±2 cm (estimado)
              </label>
            </div>
          </div>
        </div>

        <div class="btns" style="margin-top: var(--s16);">
          <button class="btn-primary" id="btnCalcular" type="button">Calcular y guardar</button>
          <button class="btn-secondary" id="btnLimpiar" type="button">Limpiar</button>
        </div>

        <div class="alerts">
          <div class="alert error" id="alertError" hidden></div>
          <div class="alert warning" id="alertWarning" hidden></div>
          <div class="alert info" id="alertInfo">
            <strong>Nota:</strong> Por defecto solo se calcula dentro del rango calibrado. Si activas extrapolaci√≥n, se permite un margen controlado (¬±2 cm).
          </div>
        </div>

        <div class="result" id="resultado" aria-live="polite">
          <div class="alert info" style="margin-top: var(--s16);">
            <strong id="resTitulo">Resultado</strong>
            <div class="help" id="resSubtitulo" style="margin-top:6px;">‚Äî</div>
          </div>

          <div class="metrics">
            <div class="metric">
              <div class="k">Altura (cm)</div>
              <div class="v" id="outAltura">‚Äî</div>
              <div class="sub" id="outAlturaSub">‚Äî</div>
            </div>
            <div class="metric">
              <div class="k">Litros (L)</div>
              <div class="v" id="outLitros">‚Äî</div>
              <div class="sub" id="outLitrosSub">‚Äî</div>
            </div>
            <div class="metric">
              <div class="k">Vac√≠o (cm)</div>
              <div class="v" id="outVacio">‚Äî</div>
              <div class="sub" id="outVacioSub">‚Äî</div>
            </div>
            <div class="metric">
              <div class="k">% de capacidad</div>
              <div class="v" id="outPct">‚Äî</div>
              <div class="sub" id="outPctSub">‚Äî</div>
            </div>
          </div>

          <div class="toast" id="toast"></div>
        </div>
      </section>

      <!-- ===================== TABLA ===================== -->
      <section class="card" aria-labelledby="hTabla">
        <div class="card-head">
          <div>
            <h2 id="hTabla">2) Tabla del tanque seleccionado</h2>
            <p class="muted">Puedes filtrar por altura o litros. La fila m√°s cercana al resultado se resalta.</p>
          </div>
          <div class="btns">
            <button class="btn-secondary" id="btnTablaCsv" type="button">Exportar tabla CSV</button>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width:220px; flex:1;">
            <label for="filtroCampo">Filtrar por</label>
            <select id="filtroCampo">
              <option value="altura">Altura (cm)</option>
              <option value="litros">Litros (L)</option>
            </select>
          </div>
          <div class="field" style="min-width:260px; flex:2;">
            <label for="filtroValor">Valor del filtro</label>
            <input id="filtroValor" type="text" inputmode="decimal" placeholder="Ej: 39 o 400" />
            <p class="help">Deja vac√≠o para ver toda la tabla.</p>
          </div>
          <div class="btns">
            <button class="btn-ghost" id="btnFiltroLimpiar" type="button">Limpiar filtro</button>
          </div>
        </div>

        <div class="table-wrap" id="tablaDatos" role="region" aria-label="Tabla de calibraci√≥n del tanque"></div>
      </section>

      <!-- ===================== HISTORIAL ===================== -->
      <section class="card" aria-labelledby="hHist">
        <div class="card-head">
          <div>
            <h2 id="hHist">3) Hist√≥rico (√∫ltimos 20 registros)</h2>
            <p class="muted">Se guarda cuando presionas <strong>Calcular y guardar</strong>. Puedes copiar o exportar.</p>
          </div>
          <div class="btns">
            <button class="btn-secondary" id="btnHistCopy" type="button">üìã Copiar</button>
            <button class="btn-secondary" id="btnHistCsv" type="button">‚¨áÔ∏è CSV</button>
            <button class="btn-ghost" id="btnHistClear" type="button">Limpiar</button>
          </div>
        </div>

        <div class="table-wrap" id="historial" role="region" aria-label="Hist√≥rico de c√°lculos"></div>
      </section>
    </main>

    <footer>
      ¬© <span id="anio"></span> ‚Äì Desarrollado por <strong>Andres Felipe Gonzalez Espindola</strong>
    </footer>
  </div>

  <script>
    (() => {
      "use strict";

      const MAX_HIST = 20;
      const LS_STATE = "tankcalc_state_v3";
      const LS_HIST  = "tankcalc_history_v3";

      // Extrapolaci√≥n controlada
      const EXTRAP_TOL_CM = 2; // ¬±2 cm

      // ===== Datos de calibraci√≥n (los tuyos) =====
      const DATA = {
        "250L":[[4.5,10],[9,20],[13,30],[17,40],[21,50],[25,60],[28.5,70],[32,80],[35.5,90],[39,100],[42.5,110],[46,120],[49,130],[52,140],[56,150],[59,160],[62,170],[65,180],[68,190],[71,200],[74,210],[76.5,220],[79,230],[81,240],[83,250]],
        "500L":[[0,0],[21,100],[30.5,150],[40,200],[49,250],[58,300],[66,350],[74,400],[83.25,450],[92.5,500]],
        "1000L":[[13.5,100],[20.3,150],[27,200],[34.5,250],[42,300],[50,350],[58,400],[65,450],[72,500],[77,550],[82,600],[87.5,650],[93,700],[99,750],[105,800],[110,850],[115,900],[121,950],[127,1000]],
        "2000L":[[12,100],[18,150],[24,200],[31.1,250],[38.2,300],[39.9,350],[41.5,400],[45.9,450],[50.3,500],[54.5,550],[59,600],[63.5,650],[68,700],[72,750],[76.5,800],[80.2,850],[84,900],[89,950],[92,1000],[96,1050],[100,1100],[104,1150],[108,1200],[112,1250],[117,1300],[121,1350],[125,1400],[128,1450],[132,1500],[135,1550],[138,1600],[142,1650],[145,1700],[148.6,1750],[152,1800],[156,1850],[158,1900],[161,1950],[164,2000]],
        "5000L":[[2.5,50],[5,100],[7.5,150],[10,200],[12.5,250],[14.5,300],[16.5,350],[18.5,400],[22.2,450],[24.5,500],[26.7,550],[27.5,600],[29.2,650],[30.7,700],[32.3,750],[34,800],[36.5,850],[39,900],[41.5,950],[44,1000],[46,1050],[48,1100],[50,1150],[52,1200],[54.2,1250],[56.2,1300],[58.4,1350],[60.5,1400],[62.4,1450],[64.5,1500],[66.5,1550],[68,1600],[70,1650],[72,1700],[74,1750],[76,1800],[77.1,1850],[79.1,1900],[81.7,1950],[83.7,2000],[85.4,2050],[87.1,2100],[88.8,2150],[90.5,2200],[92.6,2250],[94.7,2300],[96.8,2350],[99,2400],[100.7,2450],[102.5,2500],[104.2,2550],[106,2600],[108,2650],[110,2700],[112,2750],[114,2800],[115.7,2850],[117.2,2900],[119.2,2950],[121,3000],[122.7,3050],[124.5,3100],[126.2,3150],[128,3200],[129.7,3250],[131.2,3300],[133.2,3350],[135,3400],[136.7,3450],[138.4,3500],[140.2,3550],[142,3600],[143.7,3650],[145.5,3700],[147.2,3750],[149,3800],[150.7,3850],[152.2,3900],[154.2,3950],[156,4000],[158,4050],[160,4100],[162,4150],[164,4200],[166.7,4250],[168.4,4300],[170.2,4350],[171,4400],[173,4450],[175,4500],[177,4550],[179,4600],[181,4650],[183,4700],[185,4750],[187,4800],[188.8,4850],[190.7,4900],[192.6,4950],[194.5,5000]]
      };

      // ===== DOM =====
      const el = {
        tanque: document.getElementById("tanque"),
        modo: document.getElementById("modo"),
        valor: document.getElementById("valor"),
        valorLabel: document.getElementById("valorLabel"),
        rango: document.getElementById("rango"),
        tankMeta: document.getElementById("tankMeta"),
        modoHelp: document.getElementById("modoHelp"),
        autoCalc: document.getElementById("autoCalc"),
        allowExtrap: document.getElementById("allowExtrap"),

        btnCalcular: document.getElementById("btnCalcular"),
        btnLimpiar: document.getElementById("btnLimpiar"),
        btnResetState: document.getElementById("btnResetState"),

        alertError: document.getElementById("alertError"),
        alertWarning: document.getElementById("alertWarning"),

        resultado: document.getElementById("resultado"),
        resTitulo: document.getElementById("resTitulo"),
        resSubtitulo: document.getElementById("resSubtitulo"),
        outAltura: document.getElementById("outAltura"),
        outAlturaSub: document.getElementById("outAlturaSub"),
        outLitros: document.getElementById("outLitros"),
        outLitrosSub: document.getElementById("outLitrosSub"),
        outVacio: document.getElementById("outVacio"),
        outVacioSub: document.getElementById("outVacioSub"),
        outPct: document.getElementById("outPct"),
        outPctSub: document.getElementById("outPctSub"),
        toast: document.getElementById("toast"),

        tablaDatos: document.getElementById("tablaDatos"),
        btnTablaCsv: document.getElementById("btnTablaCsv"),
        filtroCampo: document.getElementById("filtroCampo"),
        filtroValor: document.getElementById("filtroValor"),
        btnFiltroLimpiar: document.getElementById("btnFiltroLimpiar"),

        historial: document.getElementById("historial"),
        btnHistClear: document.getElementById("btnHistClear"),
        btnHistCsv: document.getElementById("btnHistCsv"),
        btnHistCopy: document.getElementById("btnHistCopy"),

        anio: document.getElementById("anio")
      };

      // ===== Helpers =====
      const nf2 = new Intl.NumberFormat("es-CO", { maximumFractionDigits: 2 });

      function parseNumber(value){
        const s = String(value ?? "").trim().replace(/\s+/g, "").replace(",", ".");
        if (!s) return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function showError(msg){
        el.alertError.textContent = msg;
        el.alertError.hidden = false;
      }
      function clearError(){
        el.alertError.hidden = true;
        el.alertError.textContent = "";
      }
      function showWarning(msg){
        el.alertWarning.textContent = msg;
        el.alertWarning.hidden = false;
      }
      function clearWarning(){
        el.alertWarning.hidden = true;
        el.alertWarning.textContent = "";
      }
      function toast(msg){ el.toast.textContent = msg; }

      function downloadFile(filename, mime, content){
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // ===== Tank cache =====
      const tankCache = new Map();
      function getTank(key){
        if (tankCache.has(key)) return tankCache.get(key);

        const points = DATA[key]
          .map(([h,l]) => ({ h: Number(h), l: Number(l) }))
          .sort((a,b) => a.h - b.h);

        const minH = points[0].h;
        const maxH = points[points.length - 1].h;
        const minL = points[0].l;
        const maxL = points[points.length - 1].l;

        const tank = { key, points, minH, maxH, minL, maxL, count: points.length };
        tankCache.set(key, tank);
        return tank;
      }

      // ===== Tolerancias =====
      function getHeightRange(tank, allowExtrap){
        const min = allowExtrap ? Math.max(0, tank.minH - EXTRAP_TOL_CM) : tank.minH;
        const max = allowExtrap ? (tank.maxH + EXTRAP_TOL_CM) : tank.maxH;
        return { min, max };
      }

      function getLitersTolFrom2cm(tank){
        // Convertimos ¬±2 cm a tolerancia en litros usando la pendiente (L/cm) de los extremos.
        const pts = tank.points;
        if (pts.length < 2) return { low: 0, high: 0 };

        const p0 = pts[0], p1 = pts[1];
        const pn2 = pts[pts.length - 2], pn1 = pts[pts.length - 1];

        const dhLow = (p1.h - p0.h);
        const dhHigh = (pn1.h - pn2.h);

        const slopeLow = dhLow !== 0 ? (p1.l - p0.l) / dhLow : 0;     // L/cm
        const slopeHigh = dhHigh !== 0 ? (pn1.l - pn2.l) / dhHigh : 0; // L/cm

        return {
          low: Math.abs(slopeLow) * EXTRAP_TOL_CM,
          high: Math.abs(slopeHigh) * EXTRAP_TOL_CM
        };
      }

      function getLitersRange(tank, allowExtrap){
        if (!allowExtrap) return { min: tank.minL, max: tank.maxL };
        const tol = getLitersTolFrom2cm(tank);
        return {
          min: Math.max(0, tank.minL - tol.low),
          max: tank.maxL + tol.high
        };
      }

      // ===== Interpolaci√≥n + Extrapolaci√≥n controlada =====
      function interpWithExtrap(points, x, xKey, yKey, allowExtrap, tol){
        const n = points.length;
        const minX = points[0][xKey];
        const maxX = points[n - 1][xKey];

        const tolLow = typeof tol === "number" ? tol : (tol?.low ?? 0);
        const tolHigh = typeof tol === "number" ? tol : (tol?.high ?? 0);

        // Extrapolar por debajo
        if (x < minX){
          if (!allowExtrap) return null;
          if (x < (minX - tolLow)) return null;

          const a = points[0], b = points[1];
          const denom = (b[xKey] - a[xKey]);
          if (denom === 0) return null;

          const y = a[yKey] + (x - a[xKey]) * (b[yKey] - a[yKey]) / denom;
          return { value: y, extrapolated: true };
        }

        // Extrapolar por encima
        if (x > maxX){
          if (!allowExtrap) return null;
          if (x > (maxX + tolHigh)) return null;

          const a = points[n - 2], b = points[n - 1];
          const denom = (b[xKey] - a[xKey]);
          if (denom === 0) return null;

          const y = a[yKey] + (x - a[xKey]) * (b[yKey] - a[yKey]) / denom;
          return { value: y, extrapolated: true };
        }

        // Interpolar dentro de rango
        if (x === minX) return { value: points[0][yKey], extrapolated: false };
        if (x === maxX) return { value: points[n - 1][yKey], extrapolated: false };

        for (let i = 0; i < n - 1; i++){
          const x0 = points[i][xKey], x1 = points[i+1][xKey];
          if (x >= x0 && x <= x1){
            const y0 = points[i][yKey], y1 = points[i+1][yKey];
            const t = (x - x0) / (x1 - x0);
            return { value: y0 + t * (y1 - y0), extrapolated: false };
          }
        }
        return null;
      }

      function modeText(mode){
        if (mode === "altura") return "Altura ‚Üí Litros";
        if (mode === "litros") return "Litros ‚Üí Altura";
        return "Vac√≠o ‚Üí Litros";
      }

      // ===== Validaci√≥n con tolerancia =====
      function validateInput(tank, mode, value, allowExtrap){
        if (!Number.isFinite(value)) return "Ingresa un n√∫mero v√°lido (acepta coma o punto).";

        // Altura
        if (mode === "altura"){
          if (value < 0) return "La altura no puede ser negativa.";
          const r = getHeightRange(tank, allowExtrap);
          if (value < r.min || value > r.max){
            if (!allowExtrap){
              return `Altura fuera de rango calibrado. Rango: ${nf2.format(tank.minH)} ‚Äì ${nf2.format(tank.maxH)} cm.`;
            }
            return `Altura fuera del rango permitido. Calibrado: ${nf2.format(tank.minH)} ‚Äì ${nf2.format(tank.maxH)} cm ‚Ä¢ Con extrap.: ${nf2.format(r.min)} ‚Äì ${nf2.format(r.max)} cm.`;
          }
          return null;
        }

        // Litros
        if (mode === "litros"){
          if (value < 0) return "Los litros no pueden ser negativos.";
          const r = getLitersRange(tank, allowExtrap);
          if (value < r.min || value > r.max){
            if (!allowExtrap){
              return `Litros fuera de rango calibrado. Rango: ${nf2.format(tank.minL)} ‚Äì ${nf2.format(tank.maxL)} L.`;
            }
            return `Litros fuera del rango permitido. Calibrado: ${nf2.format(tank.minL)} ‚Äì ${nf2.format(tank.maxL)} L ‚Ä¢ Con extrap.: ${nf2.format(r.min)} ‚Äì ${nf2.format(r.max)} L.`;
          }
          return null;
        }

        // Vac√≠o
        if (mode === "vacio"){
          // Permitimos vac√≠o negativo SOLO si allowExtrap y hasta -2 cm (nivel por encima)
          const minEmpty = allowExtrap ? -EXTRAP_TOL_CM : 0;

          // Para no salir del rango de altura calibrada, el m√°ximo vac√≠o normal es (maxH - minH).
          // Con extrapolaci√≥n permitimos altura hasta (minH - 2) (limitada por 0 en altura), pero en vac√≠o eso equivale a +2 cm.
          const heightRange = getHeightRange(tank, allowExtrap);
          const maxEmpty = tank.maxH - heightRange.min; // si min baja, vac√≠o puede subir

          if (value < minEmpty || value > maxEmpty){
            if (!allowExtrap){
              return `Vac√≠o fuera de rango calibrado. Rango: 0 ‚Äì ${nf2.format(tank.maxH - tank.minH)} cm.`;
            }
            return `Vac√≠o fuera del rango permitido. Calibrado: 0 ‚Äì ${nf2.format(tank.maxH - tank.minH)} cm ‚Ä¢ Con extrap.: ${nf2.format(minEmpty)} ‚Äì ${nf2.format(maxEmpty)} cm.`;
          }

          return null;
        }

        return "Modo inv√°lido.";
      }

      // ===== C√°lculo =====
      function computeResult(tank, mode, value, allowExtrap){
        let h = null, l = null;
        let extrapolated = false;

        if (mode === "altura"){
          h = value;
          const r = interpWithExtrap(tank.points, h, "h", "l", allowExtrap, EXTRAP_TOL_CM);
          if (!r) return null;
          l = r.value;
          extrapolated = r.extrapolated;
        } else if (mode === "litros"){
          l = value;
          const tolL = getLitersTolFrom2cm(tank);
          const r = interpWithExtrap(tank.points, l, "l", "h", allowExtrap, { low: tolL.low, high: tolL.high });
          if (!r) return null;
          h = r.value;
          extrapolated = r.extrapolated;
        } else if (mode === "vacio"){
          const emptyInput = value;
          h = tank.maxH - emptyInput;
          const r = interpWithExtrap(tank.points, h, "h", "l", allowExtrap, EXTRAP_TOL_CM);
          if (!r) return null;
          l = r.value;
          extrapolated = r.extrapolated;
        } else {
          return null;
        }

        // Seguridad: litros no pueden ser negativos (puede pasar si extrapolas hacia abajo en tanques con minH=0)
        if (Number.isFinite(l) && l < 0){
          l = 0;
          extrapolated = true;
        }

        const empty = tank.maxH - h;
        const pct = (tank.maxL > 0) ? (l / tank.maxL) * 100 : NaN;

        return { h, l, empty, pct, extrapolated };
      }

      // ===== UI =====
      let currentResult = null;

      function updateTankMeta(){
        const tank = getTank(el.tanque.value);
        el.tankMeta.textContent =
          `Altura calibrada: ${nf2.format(tank.minH)}‚Äì${nf2.format(tank.maxH)} cm ‚Ä¢ Capacidad (tabla): ${nf2.format(tank.maxL)} L ‚Ä¢ Filas: ${tank.count}`;
      }

      function updateModeUI(){
        const mode = el.modo.value;
        const tank = getTank(el.tanque.value);
        const allowExtrap = el.allowExtrap.checked;

        el.valor.classList.remove("invalid");
        clearError(); clearWarning(); toast("");

        if (mode === "altura"){
          el.valorLabel.textContent = "Altura (cm)";
          el.valor.placeholder = "Ej: 39";
          el.modoHelp.textContent = "Ingresa la altura medida (cm) y obt√©n litros + vac√≠o + %.";

          const r = getHeightRange(tank, allowExtrap);
          el.rango.textContent = allowExtrap
            ? `Rango calibrado: ${nf2.format(tank.minH)}‚Äì${nf2.format(tank.maxH)} cm ‚Ä¢ Extrap: ${nf2.format(r.min)}‚Äì${nf2.format(r.max)} cm (estimado).`
            : `Rango calibrado: ${nf2.format(tank.minH)}‚Äì${nf2.format(tank.maxH)} cm.`;

        } else if (mode === "litros"){
          el.valorLabel.textContent = "Litros (L)";
          el.valor.placeholder = "Ej: 400";
          el.modoHelp.textContent = "Ingresa litros y obt√©n altura + vac√≠o + %.";

          const r = getLitersRange(tank, allowExtrap);
          el.rango.textContent = allowExtrap
            ? `Rango calibrado: ${nf2.format(tank.minL)}‚Äì${nf2.format(tank.maxL)} L ‚Ä¢ Extrap: ${nf2.format(r.min)}‚Äì${nf2.format(r.max)} L (equivale a ¬±${EXTRAP_TOL_CM} cm, estimado).`
            : `Rango calibrado: ${nf2.format(tank.minL)}‚Äì${nf2.format(tank.maxL)} L.`;

        } else {
          el.valorLabel.textContent = "Vac√≠o (cm)";
          el.valor.placeholder = "Ej: 100";
          el.modoHelp.textContent = "Ingresa el vac√≠o desde la parte superior (cm) y obt√©n litros + altura + %.";

          const heightRange = getHeightRange(tank, allowExtrap);
          const minEmpty = allowExtrap ? -EXTRAP_TOL_CM : 0;
          const maxEmpty = tank.maxH - heightRange.min;

          el.rango.textContent = allowExtrap
            ? `Rango calibrado: 0‚Äì${nf2.format(tank.maxH - tank.minH)} cm ‚Ä¢ Extrap: ${nf2.format(minEmpty)}‚Äì${nf2.format(maxEmpty)} cm (estimado).`
            : `Rango calibrado: 0‚Äì${nf2.format(tank.maxH - tank.minH)} cm.`;
        }
      }

      function hideResult(){
        currentResult = null;
        el.resultado.classList.remove("active");
        el.outAltura.textContent = "‚Äî";
        el.outLitros.textContent = "‚Äî";
        el.outVacio.textContent = "‚Äî";
        el.outPct.textContent = "‚Äî";
        el.outAlturaSub.textContent = "‚Äî";
        el.outLitrosSub.textContent = "‚Äî";
        el.outVacioSub.textContent = "‚Äî";
        el.outPctSub.textContent = "‚Äî";
        el.resSubtitulo.textContent = "‚Äî";
        toast("");
      }

      function showResult(result, mode, inputValue, isSaved){
        const tank = getTank(el.tanque.value);

        el.resultado.classList.add("active");
        el.resTitulo.textContent = `Resultado ‚Ä¢ ${tank.key}`;

        const extra = result.extrapolated ? ` ‚ö†Ô∏è Estimado por extrapolaci√≥n (¬±${EXTRAP_TOL_CM} cm).` : "";
        el.resSubtitulo.textContent =
          `Modo: ${modeText(mode)} ‚Ä¢ Entrada: ${nf2.format(inputValue)} ‚Ä¢ Interpolaci√≥n lineal.${extra} ` +
          (isSaved ? "Guardado en historial." : "Vista previa (no guardada).");

        el.outAltura.textContent = `${nf2.format(result.h)} cm`;
        el.outLitros.textContent = `${nf2.format(result.l)} L`;
        el.outVacio.textContent  = `${nf2.format(result.empty)} cm`;
        el.outPct.textContent    = `${nf2.format(result.pct)}%`;

        el.outAlturaSub.textContent = `Calibrado: ${nf2.format(tank.minH)}‚Äì${nf2.format(tank.maxH)} cm`;
        el.outLitrosSub.textContent = `Calibrado: ${nf2.format(tank.minL)}‚Äì${nf2.format(tank.maxL)} L`;
        el.outVacioSub.textContent  = `Vac√≠o = ${nf2.format(tank.maxH)} - altura`;
        el.outPctSub.textContent    = `Capacidad tabla: ${nf2.format(tank.maxL)} L`;

        toast(isSaved ? "‚úÖ C√°lculo guardado." : "üëÅÔ∏è Vista previa actualizada.");
      }

      // ===== Tabla =====
      function renderTable(result){
        const tank = getTank(el.tanque.value);

        const campo = el.filtroCampo.value;
        const fv = parseNumber(el.filtroValor.value);
        const hasFilter = Number.isFinite(fv);

        const rows = tank.points.filter(p => {
          if (!hasFilter) return true;
          const v = (campo === "altura") ? p.h : p.l;
          const tol = (campo === "altura") ? 2.0 : 100; // filtro aproximado
          return Math.abs(v - fv) <= tol;
        });

        let highlightObj = null;
        if (result && rows.length){
          let best = null, bestD = Infinity;
          for (const p of rows){
            const d = Math.abs(p.h - result.h);
            if (d < bestD){ bestD = d; best = p; }
          }
          highlightObj = best;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Altura (cm)</th>
                <th>Litros (L)</th>
                <th>Vac√≠o (cm)</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const p of rows){
          const empty = tank.maxH - p.h;
          const pct = (tank.maxL > 0) ? (p.l / tank.maxL) * 100 : NaN;
          const useHighlight = highlightObj ? (p === highlightObj) : false;

          html += `
            <tr class="${useHighlight ? "highlight" : ""}">
              <td>${nf2.format(p.h)}</td>
              <td>${nf2.format(p.l)}</td>
              <td>${nf2.format(empty)}</td>
              <td>${Number.isFinite(pct) ? nf2.format(pct) : "‚Äî"}%</td>
            </tr>
          `;
        }

        html += `</tbody></table>`;
        el.tablaDatos.innerHTML = html;
      }

      function exportTankTableCSV(){
        const tank = getTank(el.tanque.value);
        const lines = [];
        lines.push("altura_cm,litros,vacio_cm,porcentaje");

        for (const p of tank.points){
          const empty = tank.maxH - p.h;
          const pct = (tank.maxL > 0) ? (p.l / tank.maxL) * 100 : 0;
          lines.push(`${p.h.toFixed(3)},${p.l.toFixed(3)},${empty.toFixed(3)},${pct.toFixed(4)}`);
        }

        const date = new Date().toISOString().slice(0,10);
        downloadFile(`tabla_${tank.key}_${date}.csv`, "text/csv;charset=utf-8", lines.join("\n"));
        toast("‚¨áÔ∏è Tabla CSV descargada.");
      }

      // ===== Historial =====
      function loadHistory(){
        try{
          const raw = localStorage.getItem(LS_HIST);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }
      function saveHistory(arr){
        localStorage.setItem(LS_HIST, JSON.stringify(arr.slice(0, MAX_HIST)));
      }
      function addHistoryEntry(entry){
        const h = loadHistory();
        h.unshift(entry);
        saveHistory(h);
      }
      function renderHistory(){
        const h = loadHistory();
        if (!h.length){
          el.historial.innerHTML = `<div style="padding:12px;color:var(--muted);">Sin registros</div>`;
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tanque</th>
                <th>Modo</th>
                <th>Entrada</th>
                <th>Altura</th>
                <th>Litros</th>
                <th>Vac√≠o</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const r of h){
          html += `
            <tr>
              <td>${r.fecha}</td>
              <td>${r.tanque}</td>
              <td>${r.modo}</td>
              <td>${r.entrada}</td>
              <td>${r.altura}</td>
              <td>${r.litros}</td>
              <td>${r.vacio}</td>
              <td>${r.pct}</td>
            </tr>
          `;
        }

        html += `</tbody></table>`;
        el.historial.innerHTML = html;
      }

      function exportHistoryCSV(){
        const h = loadHistory();
        if (!h.length){
          toast("No hay historial para exportar.");
          return;
        }
        const lines = [];
        lines.push("fecha,tanque,modo,entrada,altura_cm,litros,vacio_cm,porcentaje");
        for (const r of h){
          lines.push(
            `"${String(r.fecha).replaceAll('"','""')}",` +
            `"${r.tanque}",` +
            `"${String(r.modo).replaceAll('"','""')}",` +
            `"${String(r.entrada).replaceAll('"','""')}",` +
            `"${r.altura}",` +
            `"${r.litros}",` +
            `"${r.vacio}",` +
            `"${r.pct}"`
          );
        }
        const date = new Date().toISOString().slice(0,10);
        downloadFile(`historial_tanques_${date}.csv`, "text/csv;charset=utf-8", lines.join("\n"));
        toast("‚¨áÔ∏è Historial CSV descargado.");
      }

      async function copyHistory(){
        const h = loadHistory();
        if (!h.length){
          toast("No hay historial para copiar.");
          return;
        }

        let text = "=== HISTORIAL TANQUES ===\n\n";
        for (const r of h){
          text += `${r.fecha} | ${r.tanque} | ${r.modo} | entrada: ${r.entrada} | altura: ${r.altura} | litros: ${r.litros} | vac√≠o: ${r.vacio} | %: ${r.pct}\n`;
        }

        try{
          if (navigator.clipboard?.writeText){
            await navigator.clipboard.writeText(text);
            toast("‚úÖ Historial copiado al portapapeles.");
            return;
          }
        }catch{}

        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand("copy");
          toast("‚úÖ Historial copiado al portapapeles.");
        }catch{
          toast("No se pudo copiar autom√°ticamente.");
        }finally{
          ta.remove();
        }
      }

      // ===== Estado (persistencia) =====
      function loadState(){
        try{
          const raw = localStorage.getItem(LS_STATE);
          if (!raw) return null;
          const s = JSON.parse(raw);
          return (s && typeof s === "object") ? s : null;
        }catch{ return null; }
      }
      function saveState(){
        const s = {
          tanque: el.tanque.value,
          modo: el.modo.value,
          valor: el.valor.value,
          autoCalc: el.autoCalc.checked,
          allowExtrap: el.allowExtrap.checked,
          filtroCampo: el.filtroCampo.value,
          filtroValor: el.filtroValor.value
        };
        localStorage.setItem(LS_STATE, JSON.stringify(s));
      }

      function resetState(){
        localStorage.removeItem(LS_STATE);
        el.valor.value = "";
        el.autoCalc.checked = false;
        el.allowExtrap.checked = false;
        el.filtroValor.value = "";
        el.filtroCampo.value = "altura";
        hideResult();
        clearError(); clearWarning(); toast("Estado restablecido.");
        renderTable(null);
        updateModeUI();
        saveState();
      }

      // ===== C√°lculo principal =====
      function runCalc({saveToHistory}){
        clearError(); clearWarning(); toast("");
        el.valor.classList.remove("invalid");

        const tank = getTank(el.tanque.value);
        const mode = el.modo.value;
        const allowExtrap = el.allowExtrap.checked;

        const v = parseNumber(el.valor.value);
        const err = validateInput(tank, mode, v, allowExtrap);

        if (err){
          showError(err);
          el.valor.classList.add("invalid");
          hideResult();
          renderTable(null);
          return;
        }

        const result = computeResult(tank, mode, v, allowExtrap);

        if (!result){
          showError("No se pudo calcular (valor fuera de rango de la tabla).");
          el.valor.classList.add("invalid");
          hideResult();
          renderTable(null);
          return;
        }

        currentResult = result;

        const warnings = [];
        if (result.extrapolated){
          warnings.push(`Resultado estimado por extrapolaci√≥n (m√°ximo ¬±${EXTRAP_TOL_CM} cm fuera del rango calibrado).`);
        }
        if (mode === "vacio" && v < 0){
          warnings.push("Vac√≠o negativo implica nivel por encima del m√°ximo calibrado (estimado).");
        }
        if (result.pct < 0 || result.pct > 100.5){
          warnings.push("El % calculado est√° fuera de 0‚Äì100%. Revisa datos o medici√≥n.");
        }
        if (warnings.length) showWarning(warnings.join(" "));

        showResult(result, mode, v, saveToHistory);
        renderTable(result);

        if (saveToHistory){
          const entry = {
            fecha: new Date().toLocaleString(),
            tanque: tank.key,
            modo: modeText(mode) + (result.extrapolated ? " (estimado)" : ""),
            entrada: `${nf2.format(v)} ${mode === "litros" ? "L" : "cm"}`,
            altura: `${nf2.format(result.h)}`,
            litros: `${nf2.format(result.l)}`,
            vacio: `${nf2.format(result.empty)}`,
            pct: `${nf2.format(result.pct)}%`
          };
          addHistoryEntry(entry);
          renderHistory();
        }

        saveState();
      }

      function clearInputs(){
        el.valor.value = "";
        el.valor.classList.remove("invalid");
        clearError(); clearWarning();
        hideResult();
        renderTable(null);
        saveState();
      }

      // ===== Init =====
      function init(){
        el.anio.textContent = new Date().getFullYear();

        // Populate tank select (orden ascendente por capacidad)
        const keys = Object.keys(DATA).sort((a,b) => parseInt(a) - parseInt(b));
        el.tanque.innerHTML = keys.map(k => `<option value="${k}">${k}</option>`).join("");

        // Restore state
        const s = loadState();
        if (s?.tanque && DATA[s.tanque]) el.tanque.value = s.tanque;
        if (s?.modo) el.modo.value = s.modo;
        if (typeof s?.valor === "string") el.valor.value = s.valor;
        if (typeof s?.autoCalc === "boolean") el.autoCalc.checked = s.autoCalc;
        if (typeof s?.allowExtrap === "boolean") el.allowExtrap.checked = s.allowExtrap;
        if (s?.filtroCampo) el.filtroCampo.value = s.filtroCampo;
        if (typeof s?.filtroValor === "string") el.filtroValor.value = s.filtroValor;

        updateTankMeta();
        updateModeUI();
        renderHistory();
        renderTable(null);

        // Events
        el.tanque.addEventListener("change", () => {
          updateTankMeta();
          updateModeUI();
          hideResult();
          renderTable(null);
          saveState();
        });

        el.modo.addEventListener("change", () => {
          updateModeUI();
          hideResult();
          renderTable(null);
          saveState();
        });

        el.allowExtrap.addEventListener("change", () => {
          updateModeUI();
          // si hay algo en pantalla y autoCalc activo, recalcular preview
          if (el.autoCalc.checked && el.valor.value.trim() !== ""){
            runCalc({saveToHistory:false});
          } else {
            renderTable(currentResult);
          }
          saveState();
        });

        el.valor.addEventListener("input", () => {
          saveState();
          if (el.autoCalc.checked){
            runCalc({saveToHistory:false});
          } else {
            clearError();
            el.valor.classList.remove("invalid");
          }
        });

        el.autoCalc.addEventListener("change", () => {
          saveState();
          if (el.autoCalc.checked && el.valor.value.trim() !== ""){
            runCalc({saveToHistory:false});
          }
        });

        el.btnCalcular.addEventListener("click", () => runCalc({saveToHistory:true}));
        el.btnLimpiar.addEventListener("click", clearInputs);
        el.btnResetState.addEventListener("click", resetState);

        el.filtroCampo.addEventListener("change", () => {
          renderTable(currentResult);
          saveState();
        });

        el.filtroValor.addEventListener("input", () => {
          renderTable(currentResult);
          saveState();
        });

        el.btnFiltroLimpiar.addEventListener("click", () => {
          el.filtroValor.value = "";
          renderTable(currentResult);
          saveState();
        });

        el.btnTablaCsv.addEventListener("click", exportTankTableCSV);

        el.btnHistClear.addEventListener("click", () => {
          localStorage.removeItem(LS_HIST);
          renderHistory();
          toast("Historial eliminado.");
        });

        el.btnHistCsv.addEventListener("click", exportHistoryCSV);
        el.btnHistCopy.addEventListener("click", copyHistory);

        // Si hay valor y autoc√°lculo activo, previsualiza
        if (el.autoCalc.checked && el.valor.value.trim() !== ""){
          runCalc({saveToHistory:false});
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
